
import React, { useEffect, useState, useRef } from "react"; 
import { listAudioFiles } from "../api/listAudioFiles";
import { getCurrentUser } from "aws-amplify/auth"; 

function AudioList() {
  const [audioFiles, setAudioFiles] = useState([]);
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState(null);
  const [lastRefresh, setLastRefresh] = useState(Date.now()); 
  const refreshIntervalRef = useRef(null); 

  // Add this new function
  const refreshFiles = async () => {
    try {
      console.log("ğŸ”„ Refreshing file list...");
      const urls = await listAudioFiles();
      setAudioFiles(urls);
      setLastRefresh(Date.now());
    } catch (err) {
      console.error("Refresh error:", err);
    }
  };

  // Add this new function
  const handleManualRefresh = async () => {
    setLoading(true);
    await refreshFiles();
    setLoading(false);
  };

  useEffect(() => {
    (async () => {
      try {
        // Make sure user is signed in
        const currentUser = await getCurrentUser();
        console.log("ğŸ‘¤ Logged in as:", currentUser.username);
        setUser(currentUser);

        // Once user is ready, list files
        const urls = await listAudioFiles();
        console.log("ğŸµ Found audio files:", urls);
        setAudioFiles(urls);
      } catch (err) {
        console.error("âŒ Error listing audio files:", err);
      } finally {
        setLoading(false);
      }
    })();

    
    // Set up auto-refresh every 10 seconds
    refreshIntervalRef.current = setInterval(refreshFiles, 10000);

    // Cleanup interval on unmount
    return () => {
      if (refreshIntervalRef.current) {
        clearInterval(refreshIntervalRef.current);
      }
    };
  }, []); // â† Make sure this dependency array stays empty

  if (loading) return <p>Loading your audio files...</p>;
  if (!user) return <p>Please sign in to view your audio files.</p>;
  if (audioFiles.length === 0) return (
    <div style={{ padding: "20px" }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
        <h3>ğŸ§ Your Audio Files</h3>
        <button 
          onClick={handleManualRefresh}
          style={{
            padding: '8px 16px',
            backgroundColor: '#007bff',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: 'pointer'
          }}
        >
          ğŸ”„ Refresh
        </button>
      </div>
      <p>No audio files found. Upload a text file and it will appear here automatically!</p>
    </div>
  );

  return (
    <div style={{ padding: "20px" }}>
      {/* â† Update this section */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
        <h3>ğŸ§ Your Audio Files</h3>
        <div>
          <button 
            onClick={handleManualRefresh}
            style={{
              padding: '8px 16px',
              backgroundColor: '#007bff',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: 'pointer',
              marginRight: '10px'
            }}
          >
            ğŸ”„ Refresh
          </button>
          <small style={{ color: '#666' }}>
            Last refreshed: {new Date(lastRefresh).toLocaleTimeString()}
          </small>
        </div>
      </div>

      <ul style={{ listStyle: "none", padding: 0 }}>
        {audioFiles.map((file) => (
          <li key={file.key} style={{ marginBottom: "15px", padding: "10px", border: "1px solid #ddd" }}>
            <audio controls src={file.url} style={{ width: "100%", maxWidth: "400px" }} />
            <p style={{ margin: "5px 0 0 0", fontSize: "14px" }}>
              {file.key.split("/").pop()}
            </p>
          </li>
        ))}
      </ul>
    </div>
  );
}

export default AudioList;